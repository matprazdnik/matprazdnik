{% load set_variable from utils %}
<script type="text/javascript" src="{{ context.STATIC_URL }}flying_rows.js"></script>
<script type="text/javascript">
    init_flying_rows();
</script>

{% if table.enable_search %}
    {% block add_form %}
        <div id="search">
        </div>
    {% endblock %}
{% endif %}

    <script type="text/javascript">
        function debug_append(s) {
            $('#debug').html($('#debug').html() + '<br>' + s);
        }
        function error(s) {
            $("#error_field").html(s);
        }
    </script>

{% block error_field %}
    <div id="error_field" style="color: red">
    </div>
{% endblock %}

<script type="text/javascript">
    var local_row_ids = {};
    var last_update_time = Math.floor(new Date().getTime() / 1000);
    {% for row in table.data %}
        local_row_ids['{{ row.id }}'] = true;
    {% endfor %}
</script>

<script type="text/javascript">
    function get_new_rows() {
        var request_data = {};
        request_data['time'] = last_update_time;
        debugger;
        last_update_time = Math.floor(new Date().getTime() / 1000);
        $.get('{{ table.get_new_url }}', request_data, function(data, status) {
                debugger;
                for (i in data.row_ids) {
                        if (!(data.row_ids[i] in local_row_ids)) {}
                            add_row(data[data.row_ids[i]]);
                        }
            })

    }

    setInterval(get_new_rows, 2000);

    function generate_handler(row_id, name, id, next_id) {
        return function(eventObj) {
            if (eventObj.keyCode == 13 || eventObj.keyCode == 9) {
                eventObj.preventDefault();
                eventObj.stopImmediatePropagation();
                eventObj.stopPropagation();
                var request_data = {};
                request_data["row_id"] = row_id;
                request_data["field_name"] = name;
                request_data["new_field_value"] = $("#" + id).text();
                var result = $.post("{{ table.update_url }}", request_data, function(data,status) {
                    debugger;
                    if (data.success == "true") {
                        $("#" + id).html(data.value);
                        if (next_id != '') {
                            $("#" + next_id).focus();
                        }
                    } else {
                        error("Incorrect value!");
                        $("#" + id).html(data.value);
                    }
                }).fail(function(data, status){
                     alert("Error sending data to server!");
                });
            }
            eventObj.stopImmediatePropagation();
            eventObj.stopPropagation();
            debug_append('keyCode ' + eventObj.keyCode);
        }
    }

    function add_row(data) { <!-- add new row from json data -->
        if (data.row_id in local_row_ids) {
            return;
        }
        local_row_ids[data.row_id] = true;
        var html_code = '';
        {% for column in table.columns %}
            html_code += '<td><span id="cell' + data.row_id + "{{ column.name }}" + '"{%if column.editable%}contenteditable="true"{%endif%} >';
            html_code += data['{{ column.name }}'];
            html_code += '</span></td>';
        {% endfor %}
        html_code = '<tr>' + html_code + '<tr>';
        $("#table").html(html_code + $("#table").html());
        {% for column in table.reversed_columns %}
            $("#cell" + data.row_id + "{{ column.name }}").bind('keydown', generate_handler(
                    data.row_id,
                    '{{ column.name }}',
                    'cell' + data.row_id + '{{ column.name }}',
                    '{% if prev %}cell' + data.row_id + '{{ prev.name }}{% endif %}'
            ));
            {% set_variable prev = column %}
        {% endfor %}
    }



</script>

{% block table %}
<table width="100%" id="data_table">
    {% block table-head %}
    <colgroup>
        {% for column in table.columns %}
            <col width="{{ column.width }}">
        {% endfor %}
    </colgroup>
    <thead>
        {% for column in table.columns %}
            <th> {{ column.verbose_name }} </th>
        {% endfor %}
    </thead>
    {% endblock %}

    {% block table-body %}
    <tbody>
        {% if table.add_new_enabled %}
        <div id="add_new_row">
            {% block add_new %}
                <tr>
                    {% for column in table.columns %}
                        <td>
                            <input type="text" placeholder="{{ column.default_text }}" id="{{ column.input_id }}" autocomplete="off" style="margin-bottom: 0">
                        </td>
                        <script type="text/javascript">
                            $("#{{ column.input_id }}").bind('keydown', function(eventObj) {
                                if (eventObj.keyCode == 13) {
                                    {% if column.next %}
                                        $("#{{ column.next.input_id }}").focus();
                                    {% else %}
                                        var request_data = {};
                                        {% for column in table.columns %}
                                            request_data["{{ column.name }}"] = $("#{{ column.input_id }}").val();
                                        {% endfor %}
                                        $.post("{{ table.add_url }}", request_data, function(data, status) {
                                            if (data.success == "true") {
                                                {% for column in table.columns %}
                                                    $("#{{ column.input_id }}").val('')
                                                {% endfor %}
                                                add_row(data);
                                                $("#input_field_{{ table.initial_focus }}").focus();
                                            } else {
                                                error("Некорректное значение: "+ data.error_message);
                                            }                                         
                                        }).fail(function(data, status) {
                                            alert("Failed to connect to server!");
                                        })
                                    {% endif %}
                                }
                            })
                        </script>
                    {% endfor %}
                </tr>
            {% endblock add_new %}
        </div>
        {% endif %}
        <tbody id="table">
        {% for row in table.data %}
            <tr>
                {% for field in row.fields %}
                    <td><span id="{{field.id}}" {%if field.editable%}contenteditable="true"{%endif%} >
                        {{ field.value }}
                    </span></td>

                    <script type="text/javascript">
                        $('#{{ field.id }}').bind(
                                'keydown',
                                generate_handler('{{ field.row_id }}', '{{ field.name }}', '{{ field.id }}', '{% if field.next %}{{ field.next.id }}{% endif %}')
                        );
                    </script>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </tbody>
    {% endblock %}
</table>
{% endblock %}

<footer id="debug">
</footer>
